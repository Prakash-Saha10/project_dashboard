{% extends 'base.html' %}
{% load static %}

{% block title %}{{ project.name }}{% endblock %}

{% block content %}
<style>
  .progress-thin {
    height: 6px;
  }
  .chart-container {
    position: relative;
    height: 250px;
    margin: 0 auto;
  }
  .team-member-avatar {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 50%;
  }
  .task-status-badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
  }
</style>

<div class="row g-4">
  <!-- Main Content -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <div>
          <h4 class="mb-1">{{ project.name }}</h4>
          <small>Managed by {{ project.manager.get_full_name }}</small>
        </div>
        <span class="badge bg-light text-dark">
          {{ project.get_status_display }}
        </span>
      </div>
      
      <div class="card-body">
        <p class="lead">{{ project.description }}</p>
        
        <!-- Project Timeline -->
        <div class="row mb-4 g-3">
          <div class="col-md-4">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Start Date</small>
              <strong>{{ project.start_date|date:"M d, Y" }}</strong>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">End Date</small>
              <strong>{{ project.end_date|date:"M d, Y" }}</strong>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Progress</small>
              <div class="progress progress-thin mt-1">
                <div class="progress-bar bg-success" style="width: {{ progress }}%"></div>
              </div>
              <strong>{{ progress }}% Complete</strong>
            </div>
          </div>
        </div>
        
        <!-- Tasks Section -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Tasks ({{ tasks.count }})</h5>
          <a href="{% url 'project_task_create' project.pk %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i> Add Task
          </a>
        </div>
        
        {% if tasks %}
        <div class="list-group">
          {% for task in tasks %}
          <a href="{% url 'task_detail' task.pk %}" 
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div class="w-75">
              <h6 class="mb-1 text-truncate">{{ task.title }}</h6>
              <small class="text-muted">
                Due: {{ task.due_date|date:"M d, Y" }} â€¢ 
                Assigned to: {{ task.assigned_to.get_full_name|default:"Unassigned" }}
              </small>
            </div>
            <span class="task-status-badge 
              {% if task.status == 'COMPLETED' %}bg-success
              {% elif task.status == 'IN_PROGRESS' %}bg-warning
              {% elif task.status == 'BLOCKED' %}bg-danger
              {% else %}bg-secondary{% endif %}">
              {{ task.get_status_display }}
            </span>
          </a>
          {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info mb-0">
          <i class="fas fa-info-circle me-2"></i>No tasks created yet
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Right Sidebar -->
  <div class="col-lg-4">
    <!-- Team Members -->
    <div class="card mb-4 shadow-sm border-0">
      <div class="card-header bg-light">
        <h5 class="mb-0">Team Members ({{ team_members.count }})</h5>
      </div>
      <div class="card-body">
        {% for member in team_members %}
        <div class="d-flex align-items-center mb-3">
          {% if member.profile_pic %}
            <img src="{{ member.profile_pic.url }}" class="team-member-avatar me-3" alt="{{ member.get_full_name }}">
          {% else %}
            <img src="{% static 'images/default-avatar.png' %}" class="team-member-avatar me-3" alt="Default avatar">
          {% endif %}
          <div class="w-100">
            <div class="d-flex justify-content-between">
              <strong>{{ member.get_full_name }}</strong>
              <small class="text-muted">{{ member.get_role_display }}</small>
            </div>
            <div class="progress progress-thin mt-1">
              <div class="progress-bar bg-info" 
                   style="width: {% widthratio member.tasks.count tasks.count 100 %}%">
              </div>
            </div>
            <small class="text-muted">{{ member.tasks.count }} tasks</small>
          </div>
        </div>
        {% empty %}
        <div class="text-center py-3">
          <i class="fas fa-users-slash text-muted fa-2x mb-2"></i>
          <p class="text-muted mb-0">No team members assigned</p>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Task Distribution Chart -->
    <div class="card shadow-sm border-0">
      <div class="card-header bg-light">
        <h5 class="mb-0">Task Distribution</h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="taskDistributionChart"></canvas>
        </div>
        <div class="mt-3 text-center">
          <span class="badge rounded-pill bg-success me-1">
            Completed: {{ completed_tasks }}
          </span>
          <span class="badge rounded-pill bg-warning me-1">
            In Progress: {{ in_progress_tasks }}
          </span>
          <span class="badge rounded-pill bg-danger me-1">
            Blocked: {{ blocked_tasks }}
          </span>
          <span class="badge rounded-pill bg-secondary">
            Not Started: {{ not_started_tasks }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Task Distribution Chart
    const ctx = document.getElementById('taskDistributionChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'In Progress', 'Blocked', 'Not Started'],
                datasets: [{
                    data: [
                        {{ completed_tasks }},
                        {{ in_progress_tasks }},
                        {{ blocked_tasks }},
                        {{ not_started_tasks }}
                    ],
                    backgroundColor: [
                        'rgba(28, 200, 138, 0.8)',    // Completed - green
                        'rgba(246, 194, 62, 0.8)',    // In Progress - yellow
                        'rgba(231, 74, 59, 0.8)',     // Blocked - red
                        'rgba(133, 135, 150, 0.8)'    // Not Started - gray
                    ],
                    borderColor: [
                        'rgba(28, 200, 138, 1)',
                        'rgba(246, 194, 62, 1)',
                        'rgba(231, 74, 59, 1)',
                        'rgba(133, 135, 150, 1)'
                    ],
                    borderWidth: 1,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 20,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '65%',
                animation: {
                    animateScale: true,
                    animateRotate: true
                }
            }
        });
    }
});
</script>
{% endblock %}